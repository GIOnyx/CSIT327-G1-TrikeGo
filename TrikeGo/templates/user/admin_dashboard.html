{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard - TrikeGo</title>
  <link rel="stylesheet" href="{% static 'user/css/admin_dashboard.css' %}?=v3">
</head>
<body>
  <header class="admin-header">
    <div class="admin-header-inner">
      <div class="brand">
        <h1>TrikeGo Admin</h1>
        <p class="sub">Welcome, {{ request.user.username }}</p>
      </div>
      <div class="admin-actions">
        <button id="push-unsubscribe-btn" class="btn btn-sm btn-outline-danger">Unsubscribe</button>
        <form method="post" action="{% url 'user:logout' %}" class="logout-form">
          {% csrf_token %}
          <button type="submit" class="logout-btn">Logout</button>
        </form>
      </div>
    </div>
  </header>

  {% if messages %}
    <div class="messages" style="padding: 1rem 2rem;">
        {% for message in messages %}
            <div class="message {{ message.tags }}" >
                {{ message }}
            </div>
        {% endfor %}
    </div>
  {% endif %}
  <main class="admin-content">
    <div class="tabs" role="tablist" aria-label="Admin sections">
      <a href="?tab=drivers" class="tab-link{% if active_tab == 'drivers' or not active_tab %} active{% endif %}" data-tab="drivers">Drivers</a>
      <a href="?tab=passengers" class="tab-link{% if active_tab == 'passengers' %} active{% endif %}" data-tab="passengers">Passengers</a>
      <a href="?tab=trips" class="tab-link{% if active_tab == 'trips' %} active{% endif %}" data-tab="trips">Trips</a>
      <a href="?tab=discounts" class="tab-link{% if active_tab == 'discounts' %} active{% endif %}" data-tab="discounts">Discount Codes</a>
    </div>
    <section class="dashboard-section tab-panel{% if active_tab == 'drivers' or not active_tab %} active{% endif %}" data-tab="drivers">
      <h2>Drivers</h2>

      <form method="get" class="trips-filters">
        <input type="hidden" name="tab" value="drivers" />
        <label>
          Search:
          <input type="text" name="d_search" value="{{ request.GET.d_search|default:'' }}" placeholder="name or username" />
        </label>
        <label>
          Status:
          <select name="d_status">
            <option value="">All</option>
            <option value="Offline" {% if request.GET.d_status == 'Offline' %}selected{% endif %}>Offline</option>
            <option value="Online" {% if request.GET.d_status == 'Online' %}selected{% endif %}>Online</option>
            <option value="In_trip" {% if request.GET.d_status == 'In_trip' %}selected{% endif %}>In trip</option>
          </select>
        </label>
        <label>
          Verified:
          <select name="d_verified">
            <option value="">Any</option>
            <option value="true" {% if request.GET.d_verified == 'true' %}selected{% endif %}>Verified</option>
            <option value="false" {% if request.GET.d_verified == 'false' %}selected{% endif %}>Unverified</option>
          </select>
        </label>
        <label>
          Sort:
          <select name="d_sort">
            <option value="">Default</option>
            <option value="name" {% if request.GET.d_sort == 'name' %}selected{% endif %}>Name</option>
            <option value="username" {% if request.GET.d_sort == 'username' %}selected{% endif %}>Username</option>
            <option value="date_hired" {% if request.GET.d_sort == 'date_hired' %}selected{% endif %}>Date Hired</option>
            <option value="status" {% if request.GET.d_sort == 'status' %}selected{% endif %}>Status</option>
          </select>
        </label>
        <label>
          Order:
          <select name="d_order">
            <option value="desc" {% if request.GET.d_order != 'asc' %}selected{% endif %}>Desc</option>
            <option value="asc" {% if request.GET.d_order == 'asc' %}selected{% endif %}>Asc</option>
          </select>
        </label>
        <button type="submit">Apply</button>
      </form>

      <table>
        <thead>
          <tr>
            <th>Driver Name</th>
            <th>Username</th>
            <th>Phone</th>
            <th>License No.</th>
            <th>License Image URL</th>
            <th>Tricycle Info</th>
            <th>Status</th>
            <th>Verified</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for driver in drivers_page.object_list %}
          <tr>
            <td>{{ driver.user.first_name }} {{ driver.user.last_name }}</td>
            <td>{{ driver.user.username }}</td>
            <td>{{ driver.user.phone }}</td>
            <td>{{ driver.license_number }}</td>
            <td>
              {% if driver.license_image_url %}
                <a href="{{ driver.license_image_url }}" target="_blank">View Image</a>
              {% else %}
                —
              {% endif %}
            </td>
            <td>
              {% with tricycle=driver.tricycles.first %}
                {% if tricycle %}
                  <strong>Plate:</strong> {{ tricycle.plate_number }}<br>
                  <strong>Color:</strong> {{ tricycle.color }}<br>
                  <strong>Capacity:</strong> {{ tricycle.max_capacity }}<br>
                  {% if tricycle.image_url %}
                    <a href="{{ tricycle.image_url }}" target="_blank">Tricycle Photo</a><br>
                  {% endif %}
                  {% if tricycle.or_image_url %}
                    <a href="{{ tricycle.or_image_url }}" target="_blank">OR Document</a><br>
                  {% endif %}
                  {% if tricycle.cr_image_url %}
                    <a href="{{ tricycle.cr_image_url }}" target="_blank">CR Document</a><br>
                  {% endif %}
                  {% if tricycle.mtop_image_url %}
                    <a href="{{ tricycle.mtop_image_url }}" target="_blank">MTOP Document</a>
                  {% endif %}
                {% else %}
                  <em>No tricycle registered</em>
                {% endif %}
              {% endwith %}
            </td>
            <td>{{ driver.status }}</td>
            <td>{{ driver.is_verified|yesno:"Yes,No" }}</td>
            <td>
              <form method="post" action="{% url 'user:admin_dashboard' %}">
                {% csrf_token %}
                <input type="hidden" name="action" value="toggle_verify" />
                <input type="hidden" name="driver_id" value="{{ driver.id }}" />
                <button type="submit">{% if driver.is_verified %}Unverify{% else %}Verify{% endif %}</button>
              </form>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="9">No drivers found.</td></tr>
          {% endfor %}
        </tbody>
      </table>

      {% if drivers_page.has_other_pages %}
      <nav class="pagination">
        {% if drivers_page.has_previous %}
          <a href="?page_drivers={{ drivers_page.previous_page_number }}&amp;tab=drivers">&laquo; Prev</a>
        {% else %}
          <span class="disabled">&laquo; Prev</span>
        {% endif %}
        <span class="page-info">Page {{ drivers_page.number }} of {{ drivers_page.paginator.num_pages }}</span>
        {% if drivers_page.has_next %}
          <a href="?page_drivers={{ drivers_page.next_page_number }}&amp;tab=drivers">Next &raquo;</a>
        {% else %}
          <span class="disabled">Next &raquo;</span>
        {% endif %}
      </nav>
      {% endif %}
    </section>

    <section class="dashboard-section tab-panel{% if active_tab == 'passengers' %} active{% endif %}" data-tab="passengers">
      <h2>Passengers</h2>

      <form method="get" class="trips-filters">
        <input type="hidden" name="tab" value="passengers" />
        <label>
          Search:
          <input type="text" name="r_search" value="{{ request.GET.r_search|default:'' }}" placeholder="name, username or email" />
        </label>
        <label>
          Status:
          <select name="r_status">
            <option value="">All</option>
            <option value="Available" {% if request.GET.r_status == 'Available' %}selected{% endif %}>Available</option>
            <option value="In_trip" {% if request.GET.r_status == 'In_trip' %}selected{% endif %}>In trip</option>
          </select>
        </label>
        <label>
          Sort:
          <select name="r_sort">
            <option value="">Default</option>
            <option value="name" {% if request.GET.r_sort == 'name' %}selected{% endif %}>Name</option>
            <option value="username" {% if request.GET.r_sort == 'username' %}selected{% endif %}>Username</option>
            <option value="loyalty" {% if request.GET.r_sort == 'loyalty' %}selected{% endif %}>Loyalty Points</option>
            <option value="status" {% if request.GET.r_sort == 'status' %}selected{% endif %}>Status</option>
          </select>
        </label>
        <label>
          Order:
          <select name="r_order">
            <option value="desc" {% if request.GET.r_order != 'asc' %}selected{% endif %}>Desc</option>
            <option value="asc" {% if request.GET.r_order == 'asc' %}selected{% endif %}>Asc</option>
          </select>
        </label>
        <button type="submit">Apply</button>
      </form>

      <table>
        <thead>
          <tr>
            <th>Passenger Name</th>
            <th>Username</th>
            <th>Email</th>
            <th>Phone</th>
          </tr>
        </thead>
        <tbody>
          {% for passenger in passengers_page.object_list %}
          <tr>
            <td>{{ passenger.user.first_name }} {{ passenger.user.last_name }}</td>
            <td>{{ passenger.user.username }}</td>
            <td>{{ passenger.user.email }}</td>
            <td>{{ passenger.user.phone }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="4">No passengers found.</td></tr>
          {% endfor %}
        </tbody>
      </table>

      {% if passengers_page.has_other_pages %}
      <nav class="pagination">
        {% if passengers_page.has_previous %}
          <a href="?page_passengers={{ passengers_page.previous_page_number }}&amp;tab=passengers">&laquo; Prev</a>
        {% else %}
          <span class="disabled">&laquo; Prev</span>
        {% endif %}
        <span class="page-info">Page {{ passengers_page.number }} of {{ passengers_page.paginator.num_pages }}</span>
        {% if passengers_page.has_next %}
          <a href="?page_passengers={{ passengers_page.next_page_number }}&amp;tab=passengers">Next &raquo;</a>
        {% else %}
          <span class="disabled">Next &raquo;</span>
        {% endif %}
      </nav>
      {% endif %}
    </section>
    <section class="dashboard-section tab-panel{% if active_tab == 'trips' %} active{% endif %}" data-tab="trips">
      <h2>Trips</h2>

      <form method="get" class="trips-filters">
        <input type="hidden" name="tab" value="trips" />
        <label>
          Status:
          <select name="status">
            <option value="">All</option>
            <option value="pending" {% if filter_status == 'pending' %}selected{% endif %}>pending</option>
            <option value="accepted" {% if filter_status == 'accepted' %}selected{% endif %}>accepted</option>
            <option value="on_the_way" {% if filter_status == 'on_the_way' %}selected{% endif %}>on_the_way</option>
            <option value="started" {% if filter_status == 'started' %}selected{% endif %}>started</option>
            <option value="completed" {% if filter_status == 'completed' %}selected{% endif %}>completed</option>
            <option value="cancelled_by_passenger" {% if filter_status == 'cancelled_by_passenger' %}selected{% endif %}>cancelled_by_passenger</option>
            <option value="cancelled_by_driver" {% if filter_status == 'cancelled_by_driver' %}selected{% endif %}>cancelled_by_driver</option>
            <option value="no_driver_found" {% if filter_status == 'no_driver_found' %}selected{% endif %}>no_driver_found</option>
          </select>
        </label>

        <label>
          Driver (username):
          <input type="text" name="driver" value="{{ filter_driver }}" placeholder="driver username" />
        </label>

        <label>
          From:
          <input type="date" name="date_from" value="{{ filter_date_from }}" />
        </label>

        <label>
          To:
          <input type="date" name="date_to" value="{{ filter_date_to }}" />
        </label>

        <button type="submit">Apply</button>
        <a href="?tab=trips" class="btn btn-sm">Reset</a>
      </form>

      <table>
        <thead>
          <tr>
            <th>Trip ID</th>
            <th>Driver</th>
            <th>Passenger</th>
            <th>Pickup</th>
            <th>Destination</th>
            <th>Fare</th>
            <th>Distance (km)</th>
            <th>Status</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody>
          {% for trip in trips_page.object_list %}
          <tr>
            <td data-label="Trip ID">{{ trip.id }}</td>
            <td data-label="Driver">
              {% if trip.driver %}
                {{ trip.driver.get_full_name|default:trip.driver.username }}
              {% else %}
                —
              {% endif %}
            </td>
            <td data-label="Passenger">
              {% if trip.passenger %}
                {{ trip.passenger.get_full_name|default:trip.passenger.username }}
              {% else %}
                —
              {% endif %}
            </td>
            <td data-label="Pickup">{{ trip.pickup_address|default:'—' }}</td>
            <td data-label="Destination">{{ trip.destination_address|default:'—' }}</td>
            <td data-label="Fare">{% if trip.fare %}₱{{ trip.fare }}{% else %}—{% endif %}</td>
            <td data-label="Distance">{% if trip.estimated_distance %}{{ trip.estimated_distance }}{% else %}—{% endif %}</td>
            <td data-label="Status">{{ trip.status }}</td>
            <td data-label="Date">{{ trip.booking_time|date:"M d, Y h:i A" }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="9">No trips found.</td></tr>
          {% endfor %}
        </tbody>
      </table>

      {% if trips_page.has_other_pages %}
      <nav class="pagination" aria-label="Trips pagination">
        {% if trips_page.has_previous %}
          <a href="?page={{ trips_page.previous_page_number }}&amp;status={{ filter_status }}&amp;driver={{ filter_driver }}&amp;date_from={{ filter_date_from }}&amp;date_to={{ filter_date_to }}&amp;tab=trips">&laquo; Prev</a>
        {% else %}
          <span class="disabled">&laquo; Prev</span>
        {% endif %}

        <span class="page-info">Page {{ trips_page.number }} of {{ trips_page.paginator.num_pages }}</span>

        {% if trips_page.has_next %}
          <a href="?page={{ trips_page.next_page_number }}&amp;status={{ filter_status }}&amp;driver={{ filter_driver }}&amp;date_from={{ filter_date_from }}&amp;date_to={{ filter_date_to }}&amp;tab=trips">Next &raquo;</a>
        {% else %}
          <span class="disabled">Next &raquo;</span>
        {% endif %}
      </nav>
      {% endif %}
    </section>
  </main>
  {# Push registration bootstrap for admins #}
  <script src="{% static 'notifications/registerPush.js' %}"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      try {
        if (window.registerForPush) {
          registerForPush('{{ request.user.trikego_user }}');
        }
      } catch (e) {
        console.warn('Push init error', e);
      }
    });
  </script>

  <script>
    // Tab switching without reload; keep URL in sync
    (function () {
      function activateTab(tab) {
        document.querySelectorAll('.tab-link').forEach(function (el) {
          el.classList.toggle('active', el.dataset.tab === tab);
        });
        document.querySelectorAll('.tab-panel').forEach(function (el) {
          el.classList.toggle('active', el.dataset.tab === tab);
        });
      }

      // initial active tab from server
      var initial = '{{ active_tab|default:"drivers" }}';
      activateTab(initial);

      document.querySelectorAll('.tab-link').forEach(function (el) {
        el.addEventListener('click', function (e) {
          // if the link is same-page toggle, prevent navigation and toggle
          var href = el.getAttribute('href') || '';
          if (href.indexOf('?') === 0) {
            e.preventDefault();
            var tab = el.dataset.tab;
            activateTab(tab);
            try {
              var url = new URL(window.location.href);
              url.searchParams.set('tab', tab);
              history.pushState({}, '', url.toString());
            } catch (err) {
              // ignore URL API errors
            }
          }
        });
      });
    })();
  </script>

  <section class="dashboard-section tab-panel{% if active_tab == 'discounts' %} active{% endif %}" data-tab="discounts">
    <h2>Create Discount Code</h2>

    <form method="post" action="?tab=discounts" class="discount-form">
        {% csrf_token %}
        {{ discount_form.as_p }}
        <button type="submit">Create Discount</button>
    </form>

    <h3>Existing Codes</h3>
    <table>
        <thead>
            <tr>
                <th>Code</th>
                <th>Type</th>
                <th>Value</th>
                <th>Active</th>
                <th>Cost</th>
                <th>Uses</th>
                <th>Max Uses</th>
                <th>Valid From</th>
                <th>Valid To</th>
            </tr>
        </thead>
        <tbody>
            {% for d in discount_codes %}
            <tr>
                <td data-label="Code">{{ d.code }}</td>
                <td data-label="Type">{{ d.get_discount_type_display }}</td>
                <td data-label="Value">{{ d.value }}</td>
                <td data-label="Active">{{ d.is_active }}</td>
                <td data-label="Cost">{{ d.cost }}</td>
                <td data-label="Uses">{{ d.uses_count }}</td>
                <td data-label="Max Uses">{{ d.max_uses }}</td>
                <td data-label="Valid From">{{ d.valid_from }}</td>
                <td data-label="Valid To">{{ d.valid_to|default:'—' }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="8">No discount codes yet.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</section>

  <!-- Push unsubscribe control (moved to header actions) -->
</body>
</html>
