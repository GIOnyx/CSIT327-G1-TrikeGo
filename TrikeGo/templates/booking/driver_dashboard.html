{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Dashboard - TrikeGo</title>
    <link rel="stylesheet" href="{% static 'user/css/driver_dashboard.css' %}?v=3" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <!-- styles moved to static/user/css/driver_dashboard.css -->
        <style>
        /* minimal inline helpers (loader only); layout is driven by static CSS in static/user/css/driver_dashboard.css */
        /* center the fetching routes loader as an overlay */
        #driver-route-loader{ position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); z-index:2250; background:rgba(255,255,255,0.98); padding:10px 12px; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.12); display:flex; gap:8px; align-items:center; }
        #driver-route-loader.hidden{ display:none !important; }
        #driver-route-loader .spinner{ width:18px; height:18px; border-radius:50%; border:3px solid #e6e6e6; border-top-color:#007bff; animation:spin 1s linear infinite; }
        @keyframes spin{ to { transform:rotate(360deg);} }
    </style>
</head>
<body {% if active_booking %}data-active-booking-id="{{ active_booking.id }}"{% endif %}>
    {# Compact driver dashboard: map fills main area; compact icon rail on the left; booking overlay pinned over map #}

    <!-- Payment PIN Modal -->
    <div id="payment-pin-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <h2 style="margin-bottom: 20px; color: #333;">üéâ Trip Completed!</h2>
            <p style="font-size: 18px; margin-bottom: 10px;">Total Fare: <strong id="modal-fare">‚Ç±0.00</strong></p>
            <p style="color: #666; margin-bottom: 25px;">Generate a PIN for the rider to verify cash payment</p>
            
            <div id="pin-generation-section">
                <button id="modal-generate-pin-btn" style="background: #007bff; color: white; border: none; padding: 15px 30px; font-size: 16px; border-radius: 8px; cursor: pointer; margin-bottom: 15px;">
                    üîë Generate Payment PIN
                </button>
            </div>
            
            <div id="pin-display-section" style="display: none;">
                <div style="background: linear-gradient(135deg, #0f2341 0%, #1a3a5f 100%); padding: 25px; border-radius: 10px; margin-bottom: 20px;">
                    <p style="color: white; margin-bottom: 10px; font-size: 14px;">Share this PIN with rider:</p>
                    <div id="modal-pin-display" style="font-size: 48px; font-weight: bold; color: white; letter-spacing: 8px; font-family: monospace;">----</div>
                    <p style="color: white; margin-top: 10px; font-size: 14px;">‚è±Ô∏è Expires in: <span id="modal-pin-timer">5:00</span></p>
                </div>
                <p style="color: #666; font-size: 14px; margin-bottom: 15px;">Waiting for rider to verify...</p>
            </div>
            
            <button id="modal-close-btn" style="background: #6c757d; color: white; border: none; padding: 12px 25px; font-size: 14px; border-radius: 6px; cursor: pointer;">
                Close
            </button>
        </div>
    </div>

    {# Driver Trip History Panel - Positioned next to sidebar #}
    <div id="driver-history-panel" style="display: none; position: fixed; top: 20px; left: 108px; width: 380px; height: calc(100vh - 40px); background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 1500; overflow: hidden;">
        <div style="display: flex; flex-direction: column; height: 100%;">
            {# Header #}
            <div style="background: linear-gradient(135deg, #0b2340 0%, #1a3a5f 100%); color: white; padding: 18px 20px; display: flex; justify-content: space-between; align-items: center;">
                <h2 style="margin: 0; font-size: 18px; font-weight: 600;">Trip History</h2>
                <button id="close-driver-history-panel" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 24px; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s;">
                    √ó
                </button>
            </div>
            
            {# Content Area #}
            <div id="history-trips-list" style="flex: 1; overflow-y: auto; padding: 12px; background: #f8f9fa;">
                <p style="text-align: center; color: #666; padding: 40px 20px;">Loading trip history...</p>
            </div>
        </div>
    </div>

    <div id="map-container">
        <div class="map-legend" id="map-legend" aria-hidden="false">
            <div class="legend-item"><span class="legend-dot driver"></span> Driver</div>
            <div class="legend-item"><span class="legend-dot pickup"></span> Pickup</div>
            <div class="legend-item"><span class="legend-dot dest"></span> Destination</div>
        </div>
    </div>
    <div id="driver-route-loader" class="hidden" aria-hidden="true">
        <div class="spinner" role="status" aria-live="polite" aria-label="Fetching routes"></div>
        <div class="route-loader-text">Fetching routes‚Ä¶</div>
    </div>

    <div class="container">
        <div class="sidebar" aria-expanded="false">
            <div class="nav-bar">
                <div class="nav-top">
                    <div class="brand" style="font-weight:700; font-size:16px; padding:12px;">TrikeGo</div>
                </div>
                <div class="nav-body">
                    <div class="nav-center">
                        <a id="profile-icon" class="nav-icon" title="Profile" href="#" aria-label="Profile">
                            <img src="{% static 'user/images/account_icon.png' %}" alt="Profile">
                        </a>
                        <a id="rides-icon" class="nav-icon" title="Rides" href="#" aria-label="Rides">
                            <img src="{% static 'user/images/tricycle_icon.png' %}" alt="Rides">
                        </a>
                        <a id="history-icon" class="nav-icon" title="Trip History" href="#" aria-label="Trip History">
                            <img src="{% static 'user/images/history.png' %}" alt="History">
                        </a>
                        <a id="payments-icon" class="nav-icon" title="Payments" href="#" aria-label="Payments">
                            <img src="{% static 'user/images/card_icon.png' %}" alt="Payments">
                        </a>
                        <a id="support-icon" class="nav-icon" title="Support" href="#" aria-label="Support">
                            <img src="{% static 'user/images/support_icon.png' %}" alt="Support">
                        </a>
                    </div>

                    <div class="sidebar-content closed">
                        <div class="sidebar-main" style="padding:12px;">
                    <h3>Profile</h3>
                    <div class="dashboard-profile-card">
                        <p><strong>{{ user.first_name }} {{ user.last_name }}</strong></p>
                        <p>Driver ID: {{ user.username }}</p>
                    </div>
                    <div style="margin-top:12px;">
                        <h4>Quick Actions</h4>
                        <a href="{% url 'user:driver_active_books' %}" class="btn btn-sm btn-outline-primary" style="display:block;margin-bottom:8px;">View My Rides</a>
                        <a href="#" class="btn btn-sm btn-outline-secondary" style="display:block;">Update Profile</a>
                    </div>
                </div>

                <div class="sidebar-rides" style="padding:12px; display:flex; flex-direction:column; height:100%">
                    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
                        <strong>Available Rides</strong>
                    </div>
                    <div id="active-rides-list" style="flex:1; overflow:auto;">
                        {% if available_rides %}
                            <ul style="list-style:none;padding:0;margin:0;">
                                {% for ride in available_rides %}
                                <li>
                                    <div class="ride-card">
                                        <div class="ride-title">{{ ride.rider.get_full_name|default:ride.rider.username }}</div>
                                        <div class="ride-meta">Pickup: {{ ride.pickup_address|truncatechars:60 }}</div>
                                        <div class="ride-meta">Dropoff: {{ ride.destination_address|truncatechars:60 }}</div>
                                    <div style="margin-top:6px; display:flex; gap:6px;">
                                        <button class="btn btn-secondary review-ride-btn" data-booking-id="{{ ride.id }}" onclick="window.reviewBooking && window.reviewBooking({{ ride.id }});">Review</button>
                                        <form class="accept-ride-form" data-booking-id="{{ ride.id }}" method="POST" action="{% url 'user:accept_ride' ride.id %}" style="display:inline;">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-success" id="accept-btn-{{ ride.id }}">Accept</button>
                                        </form>
                                    </div>
                                </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p style="padding:8px;">No rides available</p>
                        {% endif %}
                    </div>
                    <div class="rides-back-container">
                        <a href="#" id="rides-back-bottom" class="rides-back-link">Back</a>
                    </div>
                </div>
                </div>

                <div style="padding:12px;">
                    <form method="post" action="{% url 'user:logout' %}" class="logout-form" style="margin:0; padding:0;">
                        {% csrf_token %}
                        <button type="submit" class="nav-icon logout-icon" title="Logout" aria-label="Logout" style="border:none;background:transparent;padding:0;">
                            <img src="{% static 'user/images/logout.png' %}" alt="Logout">
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div id="itinerary-card" class="driver-info-card collapsed" aria-hidden="false">
            <div id="itinerary-summary" class="itinerary-summary">
                <div class="itinerary-summary-header">
                    <span><span id="summary-status-text">UP NEXT</span>: (Stop <span id="summary-stop-num">0</span> of <span id="summary-stop-total">0</span>)</span>
                    <button id="itinerary-expand-btn" type="button">View Full Itinerary</button>
                    <button id="open-chat-btn" class="chat-btn" type="button" title="Open trip chat">Trip Chat</button>
                </div>
                <h3 id="summary-action-type">--</h3>
                <p id="summary-address">Awaiting assignments.</p>
                <button id="summary-action-btn" class="btn btn-success" type="button" style="width: 100%;" disabled>Start</button>
            </div>

            <div id="itinerary-full" class="itinerary-full" style="display:none;">
                <div class="itinerary-full-header">
                    <h3>Your Trip (<span id="full-booking-count">0</span> Bookings)</h3>
                    <button id="itinerary-collapse-btn" type="button">Hide</button>
                </div>

                <div class="itinerary-stats">
                    <span>Capacity: <span id="full-capacity">0 / 0</span> Seats</span>
                    <span>Earnings: ‚Ç±<span id="full-earnings">0.00</span></span>
                </div>

                <div class="itinerary-bookings" id="itinerary-bookings" aria-live="polite"></div>

                <ul id="itinerary-stop-list" class="stop-list"></ul>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // Runtime configuration for driver_dashboard JS
        window.DRIVER_DASH_CONFIG = {
            ORS_API_KEY: '{{ settings.OPENROUTESERVICE_API_KEY }}',
            userId: {{ user.id|default:'null' }},
            csrfToken: '{{ csrf_token }}',
            itineraryEndpoint: '{% url "booking:driver_itinerary" %}',
            completeStopEndpoint: '{% url "booking:complete_itinerary_stop" %}'
        };
    </script>
    <script src="{% static 'booking/js/driver_dashboard.js' %}?v=8"></script>
    <script src="{% static 'booking/js/trip_history.js' %}"></script>

</body>
</html>