{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Dashboard - TrikeGo</title>
    <link rel="stylesheet" href="{% static 'user/css/driver_dashboard.css' %}?v=3" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <!-- styles moved to static/user/css/driver_dashboard.css -->
        <style>
        /* minimal inline helpers (loader only); layout is driven by static CSS in static/user/css/driver_dashboard.css */
        /* center the fetching routes loader as an overlay */
        #driver-route-loader{ position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); z-index:2250; background:rgba(255,255,255,0.98); padding:10px 12px; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.12); display:flex; gap:8px; align-items:center; }
        #driver-route-loader.hidden{ display:none !important; }
        #driver-route-loader .spinner{ width:18px; height:18px; border-radius:50%; border:3px solid #e6e6e6; border-top-color:#007bff; animation:spin 1s linear infinite; }
        @keyframes spin{ to { transform:rotate(360deg);} }
    </style>
</head>
<body {% if active_booking %}data-active-booking-id="{{ active_booking.id }}"{% endif %}>
    {# Compact driver dashboard: map fills main area; compact icon rail on the left; booking overlay pinned over map #}

    <div id="map-container">
        <div class="map-legend" id="map-legend" aria-hidden="false">
            <div class="legend-item"><span class="legend-dot driver"></span> Driver</div>
            <div class="legend-item"><span class="legend-dot pickup"></span> Pickup</div>
            <div class="legend-item"><span class="legend-dot dest"></span> Destination</div>
        </div>
    </div>
    <div id="driver-route-loader" class="hidden" aria-hidden="true">
        <div class="spinner" role="status" aria-live="polite" aria-label="Fetching routes"></div>
        <div class="route-loader-text">Fetching routes…</div>
    </div>

    <div class="container">
        <div class="sidebar" aria-expanded="false">
            <div class="nav-bar">
                <div class="nav-top">
                    <div class="brand" style="font-weight:700; font-size:16px; padding:12px;">TrikeGo</div>
                </div>
                <div class="nav-body">
                    <div class="nav-center">
                        <a id="profile-icon" class="nav-icon" title="Profile" href="#" aria-label="Profile">
                            <img src="{% static 'user/images/account_icon.png' %}" alt="Profile">
                        </a>
                        <a id="rides-icon" class="nav-icon" title="Rides" href="#" aria-label="Rides">
                            <img src="{% static 'user/images/tricycle_icon.png' %}" alt="Rides">
                        </a>
                        <a id="payments-icon" class="nav-icon" title="Payments" href="#" aria-label="Payments">
                            <img src="{% static 'user/images/card_icon.png' %}" alt="Payments">
                        </a>
                        <a id="support-icon" class="nav-icon" title="Support" href="#" aria-label="Support">
                            <img src="{% static 'user/images/support_icon.png' %}" alt="Support">
                        </a>
                    </div>

                    <div class="sidebar-content closed">
                        <div class="sidebar-main" style="padding:12px;">
                    <h3>Profile</h3>
                    <div class="dashboard-profile-card">
                        <p><strong>{{ user.first_name }} {{ user.last_name }}</strong></p>
                        <p>Driver ID: {{ user.username }}</p>
                    </div>
                    <div style="margin-top:12px;">
                        <h4>Quick Actions</h4>
                        <a href="{% url 'user:driver_active_books' %}" class="btn btn-sm btn-outline-primary" style="display:block;margin-bottom:8px;">View My Rides</a>
                        <a href="#" class="btn btn-sm btn-outline-secondary" style="display:block;">Update Profile</a>
                    </div>
                </div>

                <div class="sidebar-rides" style="padding:12px; display:flex; flex-direction:column; height:100%">
                    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
                        <strong>Available Rides</strong>
                    </div>
                    <div id="active-rides-list" style="flex:1; overflow:auto;">
                        {% if available_rides %}
                            <ul style="list-style:none;padding:0;margin:0;">
                                {% for ride in available_rides %}
                                <li>
                                    <div class="ride-card">
                                        <div class="ride-title">{{ ride.rider.get_full_name|default:ride.rider.username }}</div>
                                        <div class="ride-meta">Pickup: {{ ride.pickup_address|truncatechars:60 }}</div>
                                        <div class="ride-meta">Dropoff: {{ ride.destination_address|truncatechars:60 }}</div>
                                    <div style="margin-top:6px; display:flex; gap:6px;">
                                        <button class="btn btn-secondary review-ride-btn" data-booking-id="{{ ride.id }}" onclick="window.reviewBooking && window.reviewBooking({{ ride.id }});">Review</button>
                                        <form class="accept-ride-form" data-booking-id="{{ ride.id }}" method="POST" action="{% url 'user:accept_ride' ride.id %}" style="display:inline;">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-success" id="accept-btn-{{ ride.id }}">Accept</button>
                                        </form>
                                    </div>
                                </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p style="padding:8px;">No rides available</p>
                        {% endif %}
                    </div>
                    <div class="rides-back-container">
                        <a href="#" id="rides-back-bottom" class="rides-back-link">Back</a>
                    </div>
                </div>
                </div>

                <div style="padding:12px;">
                    <form method="post" action="{% url 'user:logout' %}" class="logout-form" style="margin:0; padding:0;">
                        {% csrf_token %}
                        <button type="submit" class="nav-icon logout-icon" title="Logout" aria-label="Logout" style="border:none;background:transparent;padding:0;">
                            <img src="{% static 'user/images/logout.png' %}" alt="Logout">
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div id="itinerary-card" class="driver-info-card collapsed" aria-hidden="false">
            <div id="itinerary-summary" class="itinerary-summary">
                <div class="itinerary-summary-header">
                    <span><span id="summary-status-text">UP NEXT</span>: (Stop <span id="summary-stop-num">0</span> of <span id="summary-stop-total">0</span>)</span>
                    <button id="itinerary-expand-btn" type="button">View Full Itinerary</button>
                    <button id="open-chat-btn" class="chat-btn" type="button" title="Open trip chat">Trip Chat</button>
                </div>
                <h3 id="summary-action-type">--</h3>
                <p id="summary-address">Awaiting assignments.</p>
                <button id="summary-action-btn" class="btn btn-success" type="button" style="width: 100%;" disabled>Start</button>
            </div>

            <div id="itinerary-full" class="itinerary-full" style="display:none;">
                <div class="itinerary-full-header">
                    <h3>Your Trip (<span id="full-booking-count">0</span> Bookings)</h3>
                    <button id="itinerary-collapse-btn" type="button">Hide</button>
                </div>

                <div class="itinerary-stats">
                    <span>Capacity: <span id="full-capacity">0 / 0</span> Seats</span>
                    <span>Earnings: ₱<span id="full-earnings">0.00</span></span>
                </div>

                <ul id="itinerary-stop-list" class="stop-list"></ul>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // Runtime configuration for driver_dashboard JS
        window.DRIVER_DASH_CONFIG = {
            ORS_API_KEY: '{{ settings.OPENROUTESERVICE_API_KEY }}',
            userId: {{ user.id|default:'null' }},
            csrfToken: '{{ csrf_token }}',
            itineraryEndpoint: '{% url "booking:driver_itinerary" %}',
            completeStopEndpoint: '{% url "booking:complete_itinerary_stop" %}'
        };
    </script>
    <script src="{% static 'booking/js/driver_dashboard.js' %}?v=2"></script>

</body>
</html>