{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Dashboard - TrikeGo</title>
    <link rel="stylesheet" href="{% static 'user/css/driver_dashboard.css' %}?v=4" />
    <link rel="stylesheet" href="{% static 'wallet/css/driver_wallet_panel.css' %}?v=1" />
    <link rel="stylesheet" href="{% static 'booking/css/driver_statistics_panel.css' %}?v=1" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
</head> 
<body
    data-ors-api-key="{{ settings.OPENROUTESERVICE_API_KEY }}"
    data-user-id="{{ user.id|default:'' }}"
    data-csrf-token="{{ csrf_token }}"
    data-itinerary-endpoint="{% url 'booking:driver_itinerary' %}"
    data-complete-stop-endpoint="{% url 'booking:complete_itinerary_stop' %}"
    data-available-rides-endpoint="{% url 'drivers:available_rides_api' %}"
    data-accept-url-template="{% url 'drivers:accept_ride' 0 %}"
    data-driver-status-endpoint="{% url 'drivers:driver_status' %}"
    data-driver-status="{% if driver_profile and driver_profile.status %}{{ driver_profile.status }}{% else %}Offline{% endif %}"
    data-active-trip="{% if active_booking %}1{% else %}0{% endif %}"
>
    {# Compact driver dashboard: map fills main area; compact icon rail on the left; booking overlay pinned over map #}

    <!-- Payment PIN Modal -->
    <div id="payment-pin-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <h2 style="margin-bottom: 20px; color: #333;">üéâ Trip Completed!</h2>
            <p style="font-size: 18px; margin-bottom: 10px;">Total Fare: <strong id="modal-fare">‚Ç±0.00</strong></p>
            <p style="color: #666; margin-bottom: 25px;">Generate a PIN for the passenger to verify cash payment</p>
            
            <div id="pin-generation-section">
                <button id="modal-generate-pin-btn" data-single-click style="background: #007bff; color: white; border: none; padding: 15px 30px; font-size: 16px; border-radius: 8px; cursor: pointer; margin-bottom: 15px;">
                    üîë Generate Payment PIN
                </button>
            </div>
            
            <div id="pin-display-section" style="display: none;">
                <div style="background: linear-gradient(135deg, #0f2341 0%, #1a3a5f 100%); padding: 25px; border-radius: 10px; margin-bottom: 20px;">
                    <p style="color: white; margin-bottom: 10px; font-size: 14px;">Share this PIN with passengerr:</p>
                    <div id="modal-pin-display" style="font-size: 48px; font-weight: bold; color: white; letter-spacing: 8px; font-family: monospace;">----</div>
                    <p style="color: white; margin-top: 10px; font-size: 14px;">‚è±Ô∏è Expires in: <span id="modal-pin-timer">5:00</span></p>
                </div>
                <p style="color: #666; font-size: 14px; margin-bottom: 15px;">Waiting for passenger to verify...</p>
            </div>
            
            <button id="modal-close-btn" style="background: #6c757d; color: white; border: none; padding: 12px 25px; font-size: 14px; border-radius: 6px; cursor: pointer;">
                Close
            </button>
        </div>
    </div>

    {# Driver Trip History Panel - Positioned next to sidebar #}
    <div id="driver-history-panel" class="wallet-panel driver-history-panel" aria-hidden="true">
        <div class="wallet-panel__header">
            <div>
                <h2>Trip History</h2>
                <p>Review past rides and payment status</p>
            </div>
            <button id="close-driver-history-panel" aria-label="Close trip history panel">√ó</button>
        </div>
        <div class="wallet-panel__body driver-history-panel__body">
            <div id="history-trips-list" class="driver-history-panel__list">
                <p class="driver-history-panel__empty">Loading trip history...</p>
            </div>
        </div>
    </div>

    <div id="driver-wallet-panel" class="wallet-panel" aria-hidden="true">
        <div class="wallet-panel__header">
            <div>
                <h2>Wallet</h2>
                <p>Completed trip earnings</p>
            </div>
            <button id="close-driver-wallet-panel" aria-label="Close wallet panel">√ó</button>
        </div>
        <div class="wallet-panel__body">
            <div id="wallet-panel-loader" class="wallet-panel__loader">
                <div class="spinner" aria-hidden="true"></div>
                <p>Loading earnings‚Ä¶</p>
            </div>
            <div id="wallet-panel-error" class="wallet-panel__error" role="alert" style="display:none;"></div>
            <div id="wallet-panel-content" class="wallet-panel__content" style="display:none;">
                <div class="wallet-summary-grid" aria-label="Earnings summary">
                    <div class="wallet-summary-card">
                        <span class="wallet-summary-card__label">Today</span>
                        <span id="wallet-today-total" class="wallet-summary-card__amount">‚Ç±0.00</span>
                        <span id="wallet-today-trips" class="wallet-summary-card__meta">0 trips</span>
                    </div>
                    <div class="wallet-summary-card">
                        <span class="wallet-summary-card__label">Lifetime</span>
                        <span id="wallet-lifetime-total" class="wallet-summary-card__amount">‚Ç±0.00</span>
                        <span class="wallet-summary-card__meta">All completed trips</span>
                    </div>
                </div>

                <section class="wallet-panel__section" aria-label="Daily totals">
                    <div class="wallet-panel__section-header">
                        <h3>Daily totals</h3>
                        <span>Last 14 completed days</span>
                    </div>
                    <div id="wallet-daily-list" class="wallet-panel__scroll">
                        <p class="wallet-panel__empty">No completed rides yet.</p>
                    </div>
                </section>

                <section class="wallet-panel__section" aria-label="Recent trips">
                    <div class="wallet-panel__section-header">
                        <h3>Recent trips</h3>
                        <span>Most recent 20</span>
                    </div>
                    <div id="wallet-trips-list" class="wallet-panel__scroll">
                        <p class="wallet-panel__empty">Recent trips will appear here once rides are completed.</p>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <div id="driver-rides-panel" class="wallet-panel driver-rides-panel" aria-hidden="true">
        <div class="wallet-panel__header">
            <div>
                <h2>Available Rides</h2>
                <p>Accept new bookings and view passenger details</p>
            </div>
            <button id="close-driver-rides-panel" aria-label="Close rides panel">√ó</button>
        </div>
        <div class="wallet-panel__body driver-rides-panel__body">
            <div class="driver-rides-panel__list" id="rides-panel-list">
                {% if available_rides %}
                    {% for ride in available_rides %}
                        <div class="driver-ride-card" data-booking-id="{{ ride.id }}">
                            <div class="driver-ride-card__top">
                                <div>
                                    <span class="driver-ride-card__passenger">{{ ride.passenger.get_full_name|default:ride.passenger.username }}</span>
                                    <span class="driver-ride-card__seats">{{ ride.passengers|default:1 }} passenger{{ ride.passengers|default:1|pluralize }}</span>
                                </div>
                                <div class="driver-ride-card__fare">
                                    {% with ride.fare as fare_value %}
                                        {% if fare_value %}
                                            <span class="driver-ride-card__fare-amount">‚Ç±{{ fare_value|floatformat:2 }}</span>
                                        {% else %}
                                            <span class="driver-ride-card__fare-amount driver-ride-card__fare-amount--pending">Fare pending</span>
                                        {% endif %}
                                    {% endwith %}
                                </div>
                            </div>
                            <div class="driver-ride-card__route">
                                <div class="driver-ride-card__route-item">
                                    <span class="driver-ride-card__label">from:</span>
                                    <span class="driver-ride-card__value">{{ ride.pickup_address|default:'‚Äî' }}</span>
                                </div>
                                <div class="driver-ride-card__route-item">
                                    <span class="driver-ride-card__label">to:</span>
                                    <span class="driver-ride-card__value">{{ ride.destination_address|default:'‚Äî' }}</span>
                                </div>
                            </div>
                            {% if ride.estimated_distance or ride.estimated_duration %}
                                <div class="driver-ride-card__meta">
                                    {% if ride.estimated_distance %}
                                        <span class="driver-ride-card__meta-text">Distance: {{ ride.estimated_distance|floatformat:1 }} km</span>
                                    {% endif %}
                                    {% if ride.estimated_duration %}
                                        <span class="driver-ride-card__meta-text">ETA: ~{{ ride.estimated_duration }} mins</span>
                                    {% endif %}
                                </div>
                            {% endif %}
                            <div class="driver-ride-card__actions">
                                <button class="btn btn-secondary review-ride-btn" data-booking-id="{{ ride.id }}">Review</button>
                                <form class="accept-ride-form" data-booking-id="{{ ride.id }}" method="POST" action="{% url 'drivers:accept_ride' ride.id %}">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-success" id="accept-btn-{{ ride.id }}" data-single-click>Accept</button>
                                </form>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <p class="driver-rides-panel__empty">No rides are available right now. Check back soon.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div id="driver-statistics-panel" class="wallet-panel driver-statistics-panel" aria-hidden="true">
        <div class="wallet-panel__header">
            <div>
                <h2>Performance Stats</h2>
                <p>How you&apos;re doing this week</p>
            </div>
            <button id="close-driver-statistics-panel" aria-label="Close statistics panel">√ó</button>
        </div>
        <div class="wallet-panel__body">
            <div id="driver-statistics-loader" class="wallet-panel__loader" role="status" aria-live="polite">
                <div class="spinner" aria-hidden="true"></div>
                <p>Loading statistics‚Ä¶</p>
            </div>
            <div id="driver-statistics-error" class="wallet-panel__error" role="alert" style="display:none;"></div>
            <div id="driver-statistics-content" class="wallet-panel__content driver-statistics-panel__content" style="display:none;">
                <div class="driver-statistics-summary-grid">
                    <div class="driver-statistics-card" aria-live="polite">
                        <span class="driver-statistics-card__label">Total rides</span>
                        <span id="driver-stats-total-rides" class="driver-statistics-card__value">‚Äî</span>
                        <span class="driver-statistics-card__meta">Lifetime trips</span>
                    </div>
                    <div class="driver-statistics-card">
                        <span class="driver-statistics-card__label">Completed</span>
                        <span id="driver-stats-completed-rides" class="driver-statistics-card__value">‚Äî</span>
                        <span class="driver-statistics-card__meta">Trips finished</span>
                    </div>
                    <div class="driver-statistics-card">
                        <span class="driver-statistics-card__label">Active now</span>
                        <span id="driver-stats-active-rides" class="driver-statistics-card__value">‚Äî</span>
                        <span class="driver-statistics-card__meta">Pending &amp; in-progress</span>
                    </div>
                    <div class="driver-statistics-card">
                        <span class="driver-statistics-card__label">Cancelled</span>
                        <span id="driver-stats-cancelled-rides" class="driver-statistics-card__value">‚Äî</span>
                        <span class="driver-statistics-card__meta">Passenger or driver</span>
                    </div>
                    <div class="driver-statistics-card">
                        <span class="driver-statistics-card__label">Completion rate</span>
                        <span id="driver-stats-completion-rate" class="driver-statistics-card__value">‚Äî</span>
                        <span class="driver-statistics-card__meta">Completed vs total</span>
                    </div>
                    <div class="driver-statistics-card">
                        <span class="driver-statistics-card__label">Cancellation rate</span>
                        <span id="driver-stats-cancellation-rate" class="driver-statistics-card__value">‚Äî</span>
                        <span class="driver-statistics-card__meta">Cancelled vs total</span>
                    </div>
                    <div class="driver-statistics-card">
                        <span class="driver-statistics-card__label">Avg rating</span>
                        <span id="driver-stats-average-rating" class="driver-statistics-card__value">‚Äî</span>
                        <span id="driver-stats-average-rating-meta" class="driver-statistics-card__meta">Recent feedback</span>
                    </div>
                    <div class="driver-statistics-card driver-statistics-card--highlight">
                        <span class="driver-statistics-card__label">Today&apos;s earnings</span>
                        <span id="driver-stats-today-earnings" class="driver-statistics-card__value">‚Äî</span>
                        <span class="driver-statistics-card__meta">Completed trips today</span>
                    </div>
                </div>

                <section class="driver-statistics-section" aria-label="Daily trip trends">
                    <div class="driver-statistics-section__header">
                        <h3>Last 7 days</h3>
                        <span>Completed trips per day</span>
                    </div>
                    <div class="driver-statistics-section__body">
                        <img id="driver-statistics-daily-chart" src="" alt="Bar chart showing daily trips" style="display:none;"/>
                        <ul id="driver-statistics-daily-list" class="driver-statistics-daily-list">
                            <!-- Filled via JS as fallback when chart not available -->
                        </ul>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <div id="map-container">
        <div class="map-legend" id="map-legend" aria-hidden="false">
            <div class="legend-item"><span class="legend-dot driver"></span> Driver</div>
            <div class="legend-item"><span class="legend-dot pickup"></span> Pickup</div>
            <div class="legend-item"><span class="legend-dot dest"></span> Destination</div>
        </div>
    </div>
    <div id="driver-route-loader" class="hidden" aria-hidden="true">
        <div class="spinner" role="status" aria-live="polite" aria-label="Fetching routes"></div>
        <div class="route-loader-text">Fetching routes‚Ä¶</div>
    </div>

    <button id="driver-sos-button" class="sos-button" type="button" aria-label="Emergency SOS">
        <span class="sos-button__progress" aria-hidden="true"></span>
        <span class="sos-button__label" aria-hidden="true">SOS</span>
        <span class="sos-button__hint">HOLD FOR 3 SECONDS TO CALL</span>
    </button>
    <span id="driver-sos-live-region" class="visually-hidden" aria-live="polite"></span>

    <div class="container">
        <div class="sidebar" aria-expanded="false">
            <div class="nav-bar">
                <div class="nav-top">
                    <div class="brand" style="font-weight:700; font-size:16px; padding:12px;">TrikeGo</div>
                </div>
                <div class="nav-body">
                    <div class="nav-center">
                        <a id="profile-icon" class="nav-icon" title="Profile" href="#" aria-label="Profile">
                            <img src="{% static 'user/images/account_icon.png' %}" alt="Profile">
                        </a>
                        <a id="rides-icon" class="nav-icon" title="Rides" href="#" aria-label="Rides">
                            <img src="{% static 'user/images/tricycle_icon.png' %}" alt="Rides">
                        </a>
                        <a id="history-icon" class="nav-icon" title="Trip History" href="#" aria-label="Trip History">
                            <img src="{% static 'user/images/history.png' %}" alt="History">
                        </a>
                        <a id="statistics-icon" class="nav-icon" title="Statistics" href="#" aria-label="Statistics">
                            <img src="{% static 'user/images/stats.png' %}" alt="Statistics">
                        </a>
                        <a id="payments-icon" class="nav-icon" title="Payments" href="#" aria-label="Payments">
                            <img src="{% static 'user/images/card_icon.png' %}" alt="Payments">
                        </a>
                        <a id="support-icon" class="nav-icon" title="Support" href="#" aria-label="Support">
                            <img src="{% static 'user/images/support_icon.png' %}" alt="Support">
                        </a>
                        <div id="driver-availability-control" class="availability-control">
                            <button id="driver-availability-toggle" class="availability-toggle" type="button" aria-pressed="false" aria-describedby="driver-availability-status">
                                <span class="availability-toggle__knob" aria-hidden="true"></span>
                                <span class="visually-hidden">Toggle availability</span>
                            </button>
                            <span id="driver-availability-status" class="availability-control__label">Offline</span>
                        </div>
                    </div>

                    <div class="sidebar-content closed">
                        <div class="sidebar-main" style="padding:12px;">
                    <h3>Profile</h3>
                    <div class="dashboard-profile-card">
                        <p><strong>{{ user.first_name }} {{ user.last_name }}</strong></p>
                        <p>Driver ID: {{ user.username }}</p>
                    </div>
                    <div style="margin-top:12px;">
                        <h4>Quick Actions</h4>
                        <a href="{% url 'drivers:driver_active_books' %}" class="btn btn-sm btn-outline-primary" style="display:block;margin-bottom:8px;">View My Rides</a>
                        <a href="#" class="btn btn-sm btn-outline-secondary" style="display:block;">Update Profile</a>
                    </div>
                </div>
                </div>

                <div style="padding:12px;">
                    <form method="post" action="{% url 'user:logout' %}" class="logout-form" style="margin:0; padding:0;">
                        {% csrf_token %}
                        <button type="submit" class="nav-icon logout-icon" title="Logout" aria-label="Logout" style="border:none;background:transparent;padding:0;">
                            <img src="{% static 'user/images/logout.png' %}" alt="Logout">
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div id="itinerary-card" class="driver-info-card collapsed" aria-hidden="false">
            <div id="itinerary-summary" class="itinerary-summary">
                <div class="itinerary-summary-header">
                    <span><span id="summary-status-text">UP NEXT</span>: (Stop <span id="summary-stop-num">0</span> of <span id="summary-stop-total">0</span>)</span>
                    <button id="itinerary-expand-btn" type="button" aria-expanded="false">View Full Itinerary</button>
                    <button id="open-chat-btn" class="chat-btn" type="button" title="Open trip chat">Trip Chat</button>
                </div>
                <h3 id="summary-action-type">--</h3>
                <p id="summary-address">Awaiting assignments.</p>
                <p id="summary-meta" class="summary-meta text-muted" style="margin-bottom:12px;">&nbsp;</p>
                <div class="summary-stats">
                    <span class="summary-capacity">Capacity: <span id="summary-capacity">0 / 0</span> Seats</span>
                </div>
                <button id="summary-action-btn" data-single-click class="btn btn-success" type="button" style="width: 100%;" disabled>Start</button>
            </div>

            <div id="itinerary-full" class="itinerary-full" style="display:none;">
                <div class="itinerary-full-header">
                    <h3>Your Trip (<span id="full-booking-count">0</span> Bookings)</h3>
                    <button id="itinerary-collapse-btn" type="button">Hide</button>
                </div>

                <div class="itinerary-stats">
                    <span>Capacity: <span id="full-capacity">0 / 0</span> Seats</span>
                    <span>Earnings: ‚Ç±<span id="full-earnings">0.00</span></span>
                </div>

                <div class="itinerary-bookings" id="itinerary-bookings" aria-live="polite"></div>

                <ul id="itinerary-stop-list" class="stop-list"></ul>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="{% static 'user/js/single_click_helper.js' %}"></script>
    <script src="{% static 'booking/js/driver_dashboard_config.js' %}?v=2"></script>
    <script src="{% static 'booking/js/driver_panel_manager.js' %}"></script>
    <script src="{% static 'booking/js/driver_statistics_panel.js' %}?v=1"></script>
    <script src="{% static 'booking/js/driver_dashboard.js' %}?v=14"></script>
    <script src="{% static 'wallet/js/driver_wallet.js' %}?v=2"></script>
    <script src="{% static 'booking/js/driver_rides_panel.js' %}?v=1"></script>
    <script src="{% static 'booking/js/trip_history.js' %}?v=2"></script>

    {# --- Push registration bootstrap --- #}
    <script src="{% static 'notifications/registerPush.js' %}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            try {
                if (window.registerForPush) {
                    window.registerForPush('{{ request.user.trikego_user }}');
                }
            } catch (e) {
                console.warn('Push init error', e);
            }
        });
    </script>

    <!-- Push unsubscribe control -->
    <button id="push-unsubscribe-btn" class="btn btn-sm btn-outline-danger">Unsubscribe from notifications</button>

</body>
</html>