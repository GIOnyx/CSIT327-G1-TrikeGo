{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Booking Status - TrikeGo</title>
    <link rel="stylesheet" href="{% static 'booking/css/booking.css' %}?v=2" />
</head>
<body>
    <div class="container">
        <h1>Booking #{{ booking.id }} Status</h1>
        <hr>
        <div class="booking-details">
            <p><strong>From:</strong> {{ booking.pickup_address }}</p>
            <p><strong>To:</strong> {{ booking.destination_address }}</p>
            <p><strong>Status:</strong> <span class="status-{{ booking.status }}">{{ booking.get_status_display }}</span></p>
        </div>

        {% if booking.status == 'pending' or booking.status == 'accepted' %}
            <button id="cancelBtn" class="btn btn-danger">Cancel Booking</button>
        {% endif %}

        {# Chat UI: visible only to rider or driver while booking is accepted/on_the_way/started #}
        {% if user %}
            {% if user == booking.rider or user == booking.driver %}
                {% if booking.status == 'accepted' or booking.status == 'on_the_way' or booking.status == 'started' %}
                <section id="chat" style="margin-top:20px;">
                    <h2>Chat with
                        {% if user == booking.rider and booking.driver %}
                            {{ booking.driver.username }}
                        {% else %}
                            {{ booking.rider.username }}
                        {% endif %}
                    </h2>
                    <div id="chatMessages" style="border:1px solid #ddd; padding:10px; height:300px; overflow:auto; background:#fafafa;">
                        <p id="chatLoading">Loading messages...</p>
                    </div>

                    <form id="chatForm" style="margin-top:8px; display:flex; gap:8px;">
                        <textarea id="chatInput" rows="2" style="flex:1; padding:8px;"></textarea>
                        <button id="chatSend" class="btn btn-primary" type="submit">Send</button>
                    </form>
                </section>
                {% endif %}
            {% endif %}
        {% endif %}

        <a href="{% url 'user:rider_dashboard' %}" class="btn" style="background-color: #6c757d; color: white;">Back to Dashboard</a>

        <div id="message"></div>
    </div>

    <script>
        window.BOOKING_DETAIL_CONFIG = {
            bookingId: '{{ booking.id }}',
            userId: {{ user.id|default:'null' }},
            csrfToken: '{{ csrf_token }}',
            cancelUrl: '{% url "booking:cancel_booking" booking.id %}'
        };
    </script>
    <script src="{% static 'booking/js/booking_detail.js' %}?v=1"></script>
</body>
</html>