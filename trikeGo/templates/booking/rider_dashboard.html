{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rider Dashboard - TrikeGo</title>
    <link rel="stylesheet" href="{% static 'user/css/rider_dashboard.css' %}?v=4" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
</head>
<body>
    <div id="map"></div>

    <div class="header">
        <h1>Rider Dashboard</h1>
        <a href="{% url 'user:landing' %}" class="logout-btn">Logout</a>
    </div>

    <div class="container">
        <div class="sidebar">
            <div class="dashboard-profile-card">
                <h2>Welcome, {{ user.first_name }} {{ user.last_name }}!</h2>
                <p>Rider ID: {{ user.username }}</p>
            </div>

        {% if rider_profile %}
        <div class="dashboard-loyaltypoints-card">
            <div class="loyalty-points">
                <h3>Loyalty Points</h3>
                <div class="points-number">{{ rider_profile.loyalty_points }}</div>
                <p>Earn points with every ride!</p>
            </div>
        </div>
        {% else %}
        <div class="dashboard-notrider-card">
            <h3>Rider Profile Not Found</h3>
            <p>Your rider profile is not set up yet. Please contact support.</p>
        </div>
        {% endif %}

        <div class="dashboard-quickaction-card">
            <h3>Quick Actions</h3>
            <div class="action-buttons">
                <a href="#" class="btn btn-primary">Book Ride</a>
                <a href="#" class="btn btn-secondary">Ride History</a>
                <a href="#" class="btn btn-success">Payment Methods</a>
                <a href="#" class="btn btn-warning">Support</a>
            </div>
        </div>

        <div class="dashboard-ridehistory-card">
            <h3>Recent Rides</h3>
            {% if ride_history %}
                <ul class="ride-history-list">
                    {% for booking in ride_history %}
                        <li class="ride-item">
                        From: {{ booking.pickup_address }} → {{ booking.destination_address }}<br>
                        <small>Status: {{ booking.get_status_display }}</small><br>
                        <small>Completed on: {{ booking.end_time|date:"M d, Y H:i" }}</small>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>No rides in your history yet.</p>
            {% endif %}
        </div>

        <div class="dashboard-activebooks-card">
            <h3>Active Booking</h3>
            {% if active_bookings %}
                <ul class="booking-list">
                    {% for booking in active_bookings %}
                        <li class="booking-item">
                            <strong>{{ booking.pickup_address }}</strong> → {{ booking.destination_address }}<br>
                            <small>Status: {{ booking.get_status_display }}</small><br>
                            <small>Booked at: {{ booking.booking_time|date:"M d, Y H:i" }}</small>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>No active bookings at the moment.</p>
            {% endif %}
        </div>
    </div>

        <div class="dashboard-booking-card">
            <h3>Book a Ride</h3>
            <form class="booking-form" method="POST" action="{% url 'user:rider_dashboard' %}">
                {% csrf_token %}
                
                <div class="autocomplete-container">
                    <label for="pickup_location_input">Pickup Location:</label>
                    {{ booking_form.pickup_address }}
                    <div id="pickup-results" class="autocomplete-results"></div>
                    {{ booking_form.pickup_latitude }}
                    {{ booking_form.pickup_longitude }}
                </div>

                <div class="autocomplete-container">
                    <label for="destination_location_input">Destination:</label>
                    {{ booking_form.destination_address }}
                    <div id="destination-results" class="autocomplete-results"></div>
                    {{ booking_form.destination_latitude }}
                    {{ booking_form.destination_longitude }}
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%;">Find a Trike</button>
            </form>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        const GEOAPIFY_API_KEY = '08947d7bb575492ca1ed887e2f9ae2c9';
        
        class GeoapifyAutocomplete {
            constructor(inputId, resultsId, latFieldId, lonFieldId, onSelectCallback) {
                this.input = document.getElementById(inputId);
                this.results = document.getElementById(resultsId);
                this.latField = document.getElementById(latFieldId);
                this.lonField = document.getElementById(lonFieldId);
                this.onSelectCallback = onSelectCallback;
                this.timeout = null;

                if (!this.input) {
                    console.error(`FAILED to find element with ID: #${inputId}.`);
                    return;
                }
                
                this.init();
            }
            
            init() {
                this.input.addEventListener('input', (e) => this.handleInput(e));
                document.addEventListener('click', (e) => {
                    if (!this.input.contains(e.target) && !this.results.contains(e.target)) {
                        this.results.classList.remove('active');
                    }
                });
            }
            
            handleInput(e) {
                const query = e.target.value.trim();
                clearTimeout(this.timeout);
                
                if (query.length < 3) {
                    this.results.innerHTML = '';
                    this.results.classList.remove('active');
                    return;
                }
                
                this.results.innerHTML = '<div class="loading">Searching...</div>';
                this.results.classList.add('active');
                
                this.timeout = setTimeout(() => this.search(query), 300);
            }
            
            async search(query) {
                try {
                    const url = `https://api.geoapify.com/v1/geocode/autocomplete?text=${encodeURIComponent(query)}&apiKey=${GEOAPIFY_API_KEY}&bias=countrycode:ph&filter=rect:123.8,10.2,124.0,10.4&limit=5`;
                    const response = await fetch(url);
                    const data = await response.json();
                    this.displayResults(data.features || []);
                } catch (error) {
                    console.error('Autocomplete API error:', error);
                    this.results.innerHTML = '<div class="loading">Error loading results</div>';
                }
            }
            
            displayResults(features) {
                this.results.innerHTML = '';
                if (features.length === 0) {
                    this.results.innerHTML = '<div class="loading">No results found</div>';
                    return;
                }
                features.forEach(feature => {
                    const item = document.createElement('div');
                    item.className = 'autocomplete-item';
                    const name = feature.properties.formatted;
                    item.innerHTML = `<strong>${name}</strong>`;
                    item.addEventListener('click', () => this.selectResult(feature));
                    this.results.appendChild(item);
                });
                this.results.classList.add('active');
            }
            
            selectResult(feature) {
                const lat = feature.properties.lat;
                const lon = feature.properties.lon;
                this.input.value = feature.properties.formatted;
                this.latField.value = lat;
                this.lonField.value = lon;
                this.results.classList.remove('active');
                this.results.innerHTML = '';
                
                // --- NEW --- Call the callback to update the map
                if (this.onSelectCallback) {
                    this.onSelectCallback(lat, lon);
                }
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const map = L.map('map').setView([10.3157, 123.8854], 13);
            L.tileLayer('https://maps.geoapify.com/v1/tile/osm-bright/{z}/{x}/{y}.png?apiKey={apiKey}', {
                attribution: 'Powered by Geoapify',
                maxZoom: 20,
                id: 'osm-bright',
                apiKey: GEOAPIFY_API_KEY
            }).addTo(map);

            let marker = null;
            let activeInput = null;

            const pickupInput = document.getElementById('pickup_location_input');
            const destInput = document.getElementById('destination_location_input');

            // --- NEW: Shared function to update map and marker ---
            function updateMapAndMarker(lat, lon) {
                map.setView([lat, lon], 16); // Center the map with a closer zoom
                if (marker) {
                    marker.setLatLng([lat, lon]);
                } else {
                    marker = L.marker([lat, lon]).addTo(map);
                }
            }

            // Initialize autocompletes, passing the update function
            new GeoapifyAutocomplete('pickup_location_input', 'pickup-results', 'id_pickup_latitude', 'id_pickup_longitude', updateMapAndMarker);
            new GeoapifyAutocomplete('destination_location_input', 'destination-results', 'id_destination_latitude', 'id_destination_longitude', updateMapAndMarker);

            // Track which input field is active
            pickupInput.addEventListener('focus', () => activeInput = 'pickup');
            destInput.addEventListener('focus', () => activeInput = 'destination');

            // Handle map clicks
            map.on('click', async (e) => {
                if (!activeInput) {
                    console.log("Please select a field first (pickup or destination).");
                    return;
                }

                const { lat, lng } = e.latlng;
                
                // Use the shared function
                updateMapAndMarker(lat, lng);

                // Reverse geocode to get the address
                try {
                    const url = `https://api.geoapify.com/v1/geocode/reverse?lat=${lat}&lon=${lng}&apiKey=${GEOAPIFY_API_KEY}`;
                    const response = await fetch(url);
                    const data = await response.json();

                    if (data.features?.length > 0) {
                        const address = data.features[0].properties.formatted;
                        if (activeInput === 'pickup') {
                            pickupInput.value = address;
                            document.getElementById('id_pickup_latitude').value = lat;
                            document.getElementById('id_pickup_longitude').value = lng;
                        } else if (activeInput === 'destination') {
                            destInput.value = address;
                            document.getElementById('id_destination_latitude').value = lat;
                            document.getElementById('id_destination_longitude').value = lng;
                        }
                    } else {
                        console.log("Could not find address for this location.");
                    }
                } catch (error) {
                    console.error("Reverse geocoding error:", error);
                }
            });
        });
    </script>
</body>
</html>