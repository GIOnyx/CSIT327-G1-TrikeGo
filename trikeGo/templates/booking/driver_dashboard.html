{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Dashboard - TrikeGo</title>
    <link rel="stylesheet" href="{% static 'user/css/driver_dashboard.css' %}" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
</head>
<body>
    <div class="header">
        <h1>Driver Dashboard</h1>
        <a href="{% url 'user:landing' %}" class="logout-btn">Logout</a>
    </div>

    <div class="container">
        <div class="sidebar">
            <div class="dashboard-profile-card">
                <h2>Welcome, {{ user.first_name }} {{ user.last_name }}!</h2>
                <p>Driver ID: {{ user.username }}</p>
            </div>

            <div class="dashboard-quickaction-card">
                <h3>Quick Actions</h3>
                <div class="action-buttons">
                    <a href="{% url 'user:driver_active_books' %}" class="btn btn-primary">View My Rides</a>
                    <a href="#" class="btn btn-secondary">Update Profile</a>
                </div>
            </div>
            
            {% if driver_profile %}
            <div class="dashboard-profile-card">
                <h3>Profile</h3>
                <p><strong>Status:</strong> {{ driver_profile.status }}</p>
                <p><strong>Verified:</strong> {{ driver_profile.is_verified|yesno:"Yes,No" }}</p>
            </div>
            {% endif %}
        </div>

        <div class="main-content">
            <div class="dashboard-activity-card">
                <h3>Available Rides</h3>
                {% if available_rides %}
                    <ul class="ride-list">
                        {% for ride in available_rides %}
                            <li class="ride-item">
                                <strong>From:</strong> {{ ride.pickup_address }}<br>
                                <strong>To:</strong> {{ ride.destination_address }}<br>
                                <small>Requested: {{ ride.booking_time|date:"M d, Y H:i" }}</small>
                                <div class="ride-actions">
                                    <button class="btn btn-secondary review-ride-btn" data-booking-id="{{ ride.id }}">
                                        Review
                                    </button>
                                    <form method="POST" action="{% url 'user:accept_ride' ride.id %}" style="display: inline;">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-success">Accept Ride</button>
                                    </form>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p>No rides available right now.</p>
                {% endif %}
            </div>
            
            <div class="dashboard-section">
                <h2>Ride Preview</h2>
                <div id="map-container"></div>
                <div id="route-details">Click 'Review' on a ride to see the route details here.</div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const GEOAPIFY_API_KEY = '08947d7bb575492ca1ed887e2f9ae2c9';

            const map = L.map('map-container').setView([10.3157, 123.8854], 13);
            L.tileLayer('https://maps.geoapify.com/v1/tile/osm-bright/{z}/{x}/{y}.png?apiKey={apiKey}', {
                attribution: 'Powered by Geoapify',
                maxZoom: 20,
                id: 'osm-bright',
                apiKey: GEOAPIFY_API_KEY
            }).addTo(map);

            let driverToRiderRouteLayer, riderToDestRouteLayer;
            let riderMarker, destMarker;
            const routeDetailsContainer = document.getElementById('route-details');
            const reviewButtons = document.querySelectorAll('.review-ride-btn');

            reviewButtons.forEach(button => {
                button.addEventListener('click', async function() {
                    const bookingId = this.dataset.bookingId;
                    routeDetailsContainer.innerHTML = "Fetching route information...";

                    try {
                        // 1. Get all coordinates from our backend
                        const infoResponse = await fetch(`/api/booking/${bookingId}/route_info/`);
                        const routeInfo = await infoResponse.json();

                        if (routeInfo.status !== 'success') {
                            throw new Error(routeInfo.message);
                        }
                        
                        // Clear previous layers
                        if (driverToRiderRouteLayer) driverToRiderRouteLayer.remove();
                        if (riderToDestRouteLayer) riderToDestRouteLayer.remove();
                        if (riderMarker) riderMarker.remove();
                        if (destMarker) destMarker.remove();

                        // Add markers for pickup and destination
                        const pickupLatLng = [routeInfo.pickup_lat, routeInfo.pickup_lon];
                        const destLatLng = [routeInfo.destination_lat, routeInfo.destination_lon];
                        riderMarker = L.marker(pickupLatLng).addTo(map).bindPopup('Rider Pickup');
                        destMarker = L.marker(destLatLng).addTo(map).bindPopup('Destination');

                        // 2. Fetch Driver-to-Rider route
                        const driverToRiderUrl = `https://api.geoapify.com/v1/routing?waypoints=${routeInfo.driver_lat},${routeInfo.driver_lon}|${routeInfo.pickup_lat},${routeInfo.pickup_lon}&mode=motorcycle&apiKey=${GEOAPIFY_API_KEY}`;
                        const dtResponse = await fetch(driverToRiderUrl);
                        const dtResult = await dtResponse.json();
                        
                        const dtRoute = dtResult.features[0];
                        driverToRiderRouteLayer = L.geoJSON(dtRoute, {
                            style: (feature) => ({ color: '#007bff', weight: 5, opacity: 0.8 })
                        }).addTo(map);

                        // 3. Fetch Rider-to-Destination route
                        const riderToDestUrl = `https://api.geoapify.com/v1/routing?waypoints=${routeInfo.pickup_lat},${routeInfo.pickup_lon}|${routeInfo.destination_lat},${routeInfo.destination_lon}&mode=motorcycle&apiKey=${GEOAPIFY_API_KEY}`;
                        const rdResponse = await fetch(riderToDestUrl);
                        const rdResult = await rdResponse.json();
                        
                        const rdRoute = rdResult.features[0];
                        riderToDestRouteLayer = L.geoJSON(rdRoute, {
                            style: (feature) => ({ color: '#28a745', weight: 5, opacity: 0.8 })
                        }).addTo(map);
                        
                        // Fit map to show both routes
                        const fullBounds = driverToRiderRouteLayer.getBounds().extend(riderToDestRouteLayer.getBounds());
                        map.fitBounds(fullBounds, { padding: [50, 50] });

                        // 4. Display combined details
                        const dtProps = dtRoute.properties;
                        const rdProps = rdRoute.properties;
                        const totalDistance = ((dtProps.distance + rdProps.distance) / 1000).toFixed(2);
                        const totalTime = ((dtProps.time + rdProps.time) / 60).toFixed(0);

                        routeDetailsContainer.innerHTML = `
                            <p><strong style="color: #007bff;">To Rider:</strong> ${(dtProps.distance / 1000).toFixed(2)} km / ${(dtProps.time / 60).toFixed(0)} mins</p>
                            <p><strong style="color: #28a745;">Trip to Destination:</strong> ${(rdProps.distance / 1000).toFixed(2)} km / ${(rdProps.time / 60).toFixed(0)} mins</p>
                            <hr>
                            <p><strong>Total Estimated Distance:</strong> ${totalDistance} km</p>
                            <p><strong>Total Estimated Time:</strong> ${totalTime} minutes</p>
                        `;

                    } catch (error) {
                        console.error("Routing API error:", error);
                        routeDetailsContainer.innerHTML = `Could not calculate the route. ${error.message}`;
                    }
                });
            });
        });
    </script>
</body>
</html>
